<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Coupon Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen">

    <!-- Navbar -->
    <%- include('../../views/partials/admin/navbar') %>

        <div class="flex">
            <!-- Sidebar -->
            <%- include('../../views/partials/admin/sidebar') %>

                <!-- Main Content -->
                <div class="flex-1 p-6 lg:p-8 ">
                    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-2xl font-bold text-white">Coupon Management</h1>
                            <button id="openAddModal"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300">
                                Add New Coupon
                            </button>
                        </div>

                        <!-- Coupon Table -->
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                            Coupon Code</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                            Discount</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                            Type</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                            Min Purchase</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                            Usage</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                            Created</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                            Expires</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                            Status</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-gray-800 divide-y divide-gray-700" id="couponsList">
                                    <% if (typeof coupons !=='undefined' && coupons.length> 0) { %>
                                        <% coupons.forEach(function(coupon) { %>
                                            <tr class="group">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">
                                                    <%= coupon.name %>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                                    <%= coupon.discountType==='percentage' ? coupon.offerPrice + '%'
                                                        : '₹' + coupon.offerPrice %>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                                    <%= coupon.discountType==='percentage' ? 'Percentage' : 'Amount' %>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">₹<%=
                                                        coupon.minimumPrice %>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                                    <% if (coupon.usageLimit> 0) { %>
                                                        <%= coupon.usageCount %> / <%= coupon.usageLimit %>
                                                                <% var usagePercent=Math.min(100,
                                                                    Math.round((coupon.usageCount / coupon.usageLimit) *
                                                                    100)); %>
                                                                    <div
                                                                        class="w-full bg-gray-700 rounded-full h-1.5 my-1">
                                                                        <div class="bg-blue-600 h-1.5 rounded-full"
                                                                            style="width: <%= usagePercent %>%"></div>
                                                                    </div>
                                                                    <% } else { %>
                                                                        <%= coupon.usageCount %> / ∞
                                                                            <% } %>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                                    <%= new Date(coupon.createdOn).toLocaleDateString() %>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                                    <%= new Date(coupon.expireOn).toLocaleDateString() %>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <% var isExpired=new Date(coupon.expireOn) < new Date(); %>
                                                        <% var usageLimitReached=coupon.usageLimit> 0 &&
                                                            coupon.usageCount >= coupon.usageLimit; %>
                                                            <% var isActive=coupon.isList && !isExpired &&
                                                                !usageLimitReached; %>
                                                                <span
                                                                    class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full <%= isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                                                                    <%= isActive ? 'Active' : 'Inactive' %>
                                                                </span>
                                                                <% if (usageLimitReached) { %>
                                                                    <span
                                                                        class="ml-1 px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                                                        Limit Reached
                                                                    </span>
                                                                    <% } %>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                    <button onclick="editCoupon('<%= coupon._id %>')"
                                                        class="text-indigo-400 hover:text-indigo-300 mr-3">
                                                        Edit
                                                    </button>
                                                    <button
                                                        onclick="toggleCouponStatus('<%= coupon._id %>', <%= coupon.isList %>)"
                                                        class="<%= coupon.isList ? 'text-red-400 hover:text-red-300' : 'text-green-400 hover:text-green-300' %>">
                                                        <%= coupon.isList ? 'Disable' : 'Enable' %>
                                                    </button>
                                                    <button onclick="toggleDetails('<%= coupon._id %>')"
                                                        class="text-blue-400 hover:text-blue-300 ml-3">
                                                        Details
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr id="details-<%= coupon._id %>" class="bg-gray-900 hidden">
                                                <td colspan="9" class="px-6 py-4">
                                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                        <div>
                                                            <h3 class="text-sm font-medium text-gray-300">Description
                                                            </h3>
                                                            <p class="mt-1 text-sm text-gray-400">
                                                                <%= coupon.description || 'No description provided' %>
                                                            </p>
                                                        </div>
                                                        <div>
                                                            <h3 class="text-sm font-medium text-gray-300">Usage
                                                                Statistics</h3>
                                                            <p class="mt-1 text-sm text-gray-400">
                                                                This coupon has been used <%= coupon.usageCount %> times
                                                                    <% if (coupon.usageLimit> 0) { %>
                                                                        out of a maximum of <%= coupon.usageLimit %>
                                                                            allowed uses.
                                                                            <% var remainingUses=Math.max(0,
                                                                                coupon.usageLimit - coupon.usageCount);
                                                                                %>
                                                                                <span
                                                                                    class="<%= remainingUses > 0 ? 'text-green-400' : 'text-red-400' %>">
                                                                                    (<%= remainingUses %> uses
                                                                                        remaining)
                                                                                </span>
                                                                                <% } else { %>
                                                                                    with no usage limit.
                                                                                    <% } %>
                                                            </p>
                                                        </div>
                                                    </div>

                                                    <% if (coupon.userId && coupon.userId.length> 0) { %>
                                                        <div>
                                                            <div
                                                                class="flex justify-between items-center border-t border-gray-700 pt-4 mb-2">
                                                                <h3 class="text-sm font-medium text-gray-300">Users Who
                                                                    Used This Coupon (<%= coupon.userId.length %>)</h3>
                                                                <% if (coupon.userId.length> 10) { %>
                                                                    <button
                                                                        onclick="exportUserData('<%= coupon._id %>', '<%= coupon.name %>')"
                                                                        class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded">
                                                                        Export Users
                                                                    </button>
                                                                    <% } %>
                                                            </div>
                                                            <div class="overflow-x-auto">
                                                                <table
                                                                    class="min-w-full divide-y divide-gray-700 text-sm">
                                                                    <thead class="bg-gray-800">
                                                                        <tr>
                                                                            <th
                                                                                class="px-3 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                                                                Name</th>
                                                                            <th
                                                                                class="px-3 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                                                                Email</th>
                                                                            <th
                                                                                class="px-3 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                                                                Phone</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody class="bg-gray-800 divide-y divide-gray-700">
                                                                        <% coupon.userId.forEach(function(user) { %>
                                                                            <tr>
                                                                                <td class="px-3 py-2 whitespace-nowrap">
                                                                                    <%= user.firstname %>
                                                                                        <%= user.lastname || '' %>
                                                                                </td>
                                                                                <td class="px-3 py-2 whitespace-nowrap">
                                                                                    <%= user.email %>
                                                                                </td>
                                                                                <td class="px-3 py-2 whitespace-nowrap">
                                                                                    <%= user.phNumber || 'N/A' %>
                                                                                </td>
                                                                            </tr>
                                                                            <% }); %>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                        <% } else { %>
                                                            <div class="border-t border-gray-700 pt-4">
                                                                <h3 class="text-sm font-medium text-gray-300 mb-2">Users
                                                                    Who Used This Coupon</h3>
                                                                <p class="text-sm text-gray-400">No users have used this
                                                                    coupon yet.</p>
                                                            </div>
                                                            <% } %>
                                                </td>
                                            </tr>
                                            <% }); %>
                                                <% } else { %>
                                                    <tr>
                                                        <td colspan="9"
                                                            class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 text-center">
                                                            No coupons found. Add a new coupon to get started.</td>
                                                    </tr>
                                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
        </div>

        <div id="addCouponModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="relative bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4">
                <div class="flex justify-between items-center p-5 border-b border-gray-700">
                    <h3 class="text-xl font-semibold text-white" id="modalTitle">Add New Coupon</h3>
                    <button id="closeAddModal" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <form id="couponForm" action="/admin/add-coupon" method="POST">
                    <input type="hidden" id="couponId" name="couponId">
                    <div class="p-5 grid grid-cols-2 gap-4">
                        <div class="space-y-4">
                            <div>
                                <label for="name" class="block text-sm font-medium text-gray-300">Coupon Code</label>
                                <input type="text" name="name" id="name"
                                    class="mt-1 block w-full py-2 px-3 border border-gray-600 bg-gray-700 rounded-md shadow-sm text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                    required>
                                <p id="nameHelpText" class="mt-1 text-xs text-gray-400">Code should be uppercase without
                                    spaces (e.g.,
                                    SUMMER25)</p>
                            </div>
                            <div>
                                <label for="discountType" class="block text-sm font-medium text-gray-300">Discount
                                    Type</label>
                                <select name="discountType" id="discountType"
                                    class="mt-1 block w-full py-2 px-3 border border-gray-600 bg-gray-700 rounded-md shadow-sm text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                    required>
                                    <option value="amount">Fixed Amount (₹)</option>
                                    <option value="percentage">Percentage (%)</option>
                                </select>
                            </div>
                            <div>
                                <label for="minimumPrice" class="block text-sm font-medium text-gray-300">Minimum
                                    Purchase (₹)</label>
                                <input type="number" name="minimumPrice" id="minimumPrice" min="0"
                                    class="mt-1 block w-full py-2 px-3 border border-gray-600 bg-gray-700 rounded-md shadow-sm text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                    required>
                                <p class="mt-1 text-xs text-gray-400">Discount amount must be less than minimum purchase
                                    amount</p>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label for="description"
                                    class="block text-sm font-medium text-gray-300">Description</label>
                                <textarea name="description" id="description" rows="2"
                                    class="mt-1 block w-full py-2 px-3 border border-gray-600 bg-gray-700 rounded-md shadow-sm text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                                <p class="mt-1 text-xs text-gray-400">Optional: Add a brief description about this
                                    coupon</p>
                            </div>
                            <div>
                                <label for="offerPrice" class="block text-sm font-medium text-gray-300">Discount
                                    Value</label>
                                <input type="number" name="offerPrice" id="offerPrice" min="1"
                                    class="mt-1 block w-full py-2 px-3 border border-gray-600 bg-gray-700 rounded-md shadow-sm text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                    required>
                                <p class="mt-1 text-xs text-gray-400" id="offerPriceNote">For fixed amount: must be less
                                    than minimum purchase. For percentage: must be between 1-100.</p>
                            </div>
                            <div>
                                <label for="usageLimit" class="block text-sm font-medium text-gray-300">Usage
                                    Limit</label>
                                <input type="number" name="usageLimit" id="usageLimit" min="0"
                                    class="mt-1 block w-full py-2 px-3 border border-gray-600 bg-gray-700 rounded-md shadow-sm text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <p class="mt-1 text-xs text-gray-400">Maximum number of times this coupon can be used (0
                                    = unlimited)</p>
                            </div>
                            <div>
                                <label for="expireOn" class="block text-sm font-medium text-gray-300">Expiry
                                    Date</label>
                                <input type="date" name="expireOn" id="expireOn"
                                    class="mt-1 block w-full py-2 px-3 border border-gray-600 bg-gray-700 rounded-md shadow-sm text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                    required>
                            </div>
                        </div>
                    </div>
                    <div class="px-5 py-4 bg-gray-700 rounded-b-lg flex justify-end">
                        <button type="button" id="cancelButton"
                            class="bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-4 rounded-lg mr-2">
                            Cancel
                        </button>
                        <button type="submit"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg">
                            Save Coupon
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            var addModal = document.getElementById('addCouponModal');
            var openAddModalBtn = document.getElementById('openAddModal');
            var closeAddModalBtn = document.getElementById('closeAddModal');
            var cancelButton = document.getElementById('cancelButton');
            var couponForm = document.getElementById('couponForm');
            var modalTitle = document.getElementById('modalTitle');

            var expireOnInput = document.getElementById('expireOn');
            var today = new Date();
            var formattedDate = today.toISOString().split('T')[0];
            expireOnInput.min = formattedDate;

            var offerPriceInput = document.getElementById('offerPrice');
            var minimumPriceInput = document.getElementById('minimumPrice');
            var discountTypeInput = document.getElementById('discountType');

            updateOfferPriceLabel();

            discountTypeInput.addEventListener('change', function () {
                validatePrices();
                updateOfferPriceLabel();
            });

            function updateOfferPriceLabel() {
                var discountType = discountTypeInput.value;
                var offerPriceNote = document.getElementById('offerPriceNote');

                if (discountType === 'percentage') {
                    offerPriceNote.textContent = 'Percentage discount must be between 1 and 100';
                    offerPriceInput.max = 100;
                } else {
                    offerPriceNote.textContent = 'Discount amount must be less than minimum purchase amount';
                    offerPriceInput.removeAttribute('max');
                }
            }

            var validatePrices = function () {
                var offerPrice = Number(offerPriceInput.value);
                var minimumPrice = Number(minimumPriceInput.value);
                var discountType = discountTypeInput.value;

                if (discountType === 'percentage') {
                    if (offerPrice <= 0 || offerPrice > 100) {
                        offerPriceInput.setCustomValidity('Percentage discount must be between 1 and 100');
                        return false;
                    } else {
                        offerPriceInput.setCustomValidity('');
                        return true;
                    }
                } else {
                    if (offerPrice && minimumPrice && offerPrice >= minimumPrice) {
                        offerPriceInput.setCustomValidity('Discount amount must be less than minimum purchase amount');
                        return false;
                    } else {
                        offerPriceInput.setCustomValidity('');
                        return true;
                    }
                }
            };

            offerPriceInput.addEventListener('input', validatePrices);
            minimumPriceInput.addEventListener('input', validatePrices);

            openAddModalBtn.addEventListener('click', function () {
                modalTitle.textContent = 'Add New Coupon';
                couponForm.reset();
                couponForm.action = '/admin/add-coupon';
                document.getElementById('couponId').value = '';

                const nameInput = document.getElementById('name');
                nameInput.readOnly = false; 

                const nameHelpText = document.getElementById('nameHelpText');
                nameHelpText.textContent = 'Code should be uppercase without spaces (e.g., SUMMER25)';
                nameHelpText.classList.remove('hidden');

                addModal.classList.remove('hidden');
            });


            function closeModal() {
                addModal.classList.add('hidden');
            }

            closeAddModalBtn.addEventListener('click', closeModal);
            cancelButton.addEventListener('click', closeModal);

            addModal.addEventListener('click', function (e) {
                if (e.target === addModal) {
                    closeModal();
                }
            });

            function editCoupon(couponId) {
                modalTitle.textContent = 'Edit Coupon';
                couponForm.action = '/admin/edit-coupon';
                document.getElementById('couponId').value = couponId;

                fetch('/admin/get-coupon/' + couponId)
                    .then(function (response) { return response.json(); })
                    .then(function (coupon) {
                        const nameHelpText = document.getElementById('nameHelpText');
                        nameHelpText.textContent = 'Coupon name cannot be changed after creation';
                        nameHelpText.classList.remove('hidden');
                        document.getElementById('name').value = coupon.name;
                        document.getElementById('name').readOnly = true;
                        document.getElementById('description').value = coupon.description || '';
                        document.getElementById('offerPrice').value = coupon.offerPrice;
                        document.getElementById('minimumPrice').value = coupon.minimumPrice;
                        document.getElementById('discountType').value = coupon.discountType || 'amount';
                        document.getElementById('usageLimit').value = coupon.usageLimit || 0;
                        document.getElementById('expireOn').value = new Date(coupon.expireOn).toISOString().split('T')[0];
                        updateOfferPriceLabel();
                        addModal.classList.remove('hidden');
                    })
                    .catch(function (error) {
                        console.error('Error fetching coupon details:', error);
                        swal("Error", "Failed to fetch coupon details", "error");
                    });
            }

            function toggleCouponStatus(couponId, currentStatus) {
                var action = currentStatus ? 'disable' : 'enable';

                swal({
                    title: action.charAt(0).toUpperCase() + action.slice(1) + " this coupon?",
                    text: currentStatus ? "Users won't be able to use this coupon anymore." : "This will make the coupon available to users.",
                    icon: "warning",
                    buttons: true,
                    dangerMode: currentStatus
                })
                    .then(function (willToggle) {
                        if (willToggle) {
                            fetch('/admin/toggle-coupon/' + couponId, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ status: !currentStatus })
                            })
                                .then(function (response) { return response.json(); })
                                .then(function (data) {
                                    if (data.success) {
                                        swal("Success", "Coupon " + action + "d successfully", "success")
                                            .then(function () {
                                                window.location.reload();
                                            });
                                    } else {
                                        swal("Error", data.message || "Something went wrong", "error");
                                    }
                                })
                                .catch(function (error) {
                                    console.error('Error toggling coupon status:', error);
                                    swal("Error", "Failed to update coupon status", "error");
                                });
                        }
                    });
            }

            couponForm.addEventListener('submit', function (event) {
                event.preventDefault();

                var couponName = document.getElementById('name').value;
                if (couponName !== couponName.toUpperCase() || couponName.includes(' ')) {
                    swal("Invalid Format", "Coupon code must be uppercase and contain no spaces", "warning");
                    return;
                }

                var offerPrice = Number(document.getElementById('offerPrice').value);
                var minimumPrice = Number(document.getElementById('minimumPrice').value);
                var discountType = document.getElementById('discountType').value;

                if (discountType === 'percentage') {
                    if (offerPrice <= 0 || offerPrice > 100) {
                        swal("Invalid Percentage", "Percentage discount must be between 1 and 100", "warning");
                        return;
                    }
                } else {
                    if (offerPrice >= minimumPrice) {
                        swal("Invalid Amount", "Discount amount must be less than minimum purchase amount", "warning");
                        return;
                    }
                }

                var formAction = couponForm.action;
                var isEdit = formAction.includes('edit-coupon');

                var formData = {
                    name: couponName,
                    description: document.getElementById('description').value,
                    offerPrice: offerPrice,
                    minimumPrice: minimumPrice,
                    discountType: discountType,
                    usageLimit: Number(document.getElementById('usageLimit').value) || 0,
                    expireOn: document.getElementById('expireOn').value
                };

                if (isEdit) {
                    formData.couponId = document.getElementById('couponId').value;
                }

                fetch(formAction, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                })
                    .then(function (response) { return response.json(); })
                    .then(function (data) {
                        if (data.success) {
                            swal("Success", isEdit ? "Coupon updated successfully" : "Coupon created successfully", "success")
                                .then(function () {
                                    window.location.reload();
                                });
                        } else {
                            swal("Error", data.message || "Something went wrong", "error");
                        }
                    })
                    .catch(function (error) {
                        console.error('Error submitting coupon form:', error);
                        swal("Error", "Failed to " + (isEdit ? "update" : "create") + " coupon", "error");
                    });
            });

            function toggleDetails(couponId) {
                var detailsRow = document.getElementById('details-' + couponId);
                if (detailsRow) {
                    detailsRow.classList.toggle('hidden');
                }
            }


        </script>
</body>

</html>